

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>features_utilities &mdash; LGM-Classification  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> LGM-Classification
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../adjacency_features.html">Adjacency features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../textual_features.html">Textual features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../features_utilities.html">Features utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clf_utilities.html">Classifiers utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../osm_utilities.html">OSM utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writers.html">Writers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config.html">Config</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">LGM-Classification</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>features_utilities</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for features_utilities</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">shapely.wkt</span> <span class="k">import</span> <span class="n">loads</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="k">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="k">import</span> <span class="n">SelectPercentile</span><span class="p">,</span> <span class="n">chi2</span>


<span class="kn">import</span> <span class="nn">adjacency_features</span> <span class="k">as</span> <span class="nn">af</span>
<span class="kn">import</span> <span class="nn">textual_features</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="c1"># import geometric_features as gf</span>
<span class="c1"># import matching as m</span>
<span class="kn">import</span> <span class="nn">osm_utilities</span> <span class="k">as</span> <span class="nn">osm_ut</span>
<span class="kn">import</span> <span class="nn">writers</span> <span class="k">as</span> <span class="nn">wrtrs</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="k">import</span> <span class="n">config</span>


<span class="n">feature_module_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;classes_in_radius_bln&#39;</span><span class="p">:</span> <span class="n">af</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_radius_cnt&#39;</span><span class="p">:</span> <span class="n">af</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_and_radius_bln&#39;</span><span class="p">:</span> <span class="n">af</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_and_radius_cnt&#39;</span><span class="p">:</span> <span class="n">af</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_neighbors_bln&#39;</span><span class="p">:</span> <span class="n">af</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_neighbors_cnt&#39;</span><span class="p">:</span> <span class="n">af</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_radius_bln&#39;</span><span class="p">:</span> <span class="n">af</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_radius_cnt&#39;</span><span class="p">:</span> <span class="n">af</span><span class="p">,</span>
    <span class="s1">&#39;similarity_per_class&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="p">,</span>
    <span class="s1">&#39;top_k_terms&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="p">,</span>
    <span class="s1">&#39;top_k_trigrams&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="p">,</span>
    <span class="s1">&#39;top_k_fourgrams&#39;</span><span class="p">:</span> <span class="n">tf</span>
<span class="p">}</span>

<span class="n">features_getter_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;classes_in_radius_bln&#39;</span><span class="p">:</span> <span class="s1">&#39;get_classes_in_radius_bln&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_radius_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;get_classes_in_radius_cnt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_and_radius_bln&#39;</span><span class="p">:</span> <span class="s1">&#39;get_classes_in_street_and_radius_bln&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_and_radius_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;get_classes_in_street_and_radius_cnt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_neighbors_bln&#39;</span><span class="p">:</span> <span class="s1">&#39;get_classes_in_neighbors_bln&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_neighbors_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;get_classes_in_neighbors_cnt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_radius_bln&#39;</span><span class="p">:</span> <span class="s1">&#39;get_classes_in_street_radius_bln&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_radius_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;get_classes_in_street_radius_cnt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;similarity_per_class&#39;</span><span class="p">:</span> <span class="s1">&#39;get_similarity_per_class&#39;</span><span class="p">,</span>
    <span class="s1">&#39;top_k_terms&#39;</span><span class="p">:</span> <span class="s1">&#39;get_top_k_terms&#39;</span><span class="p">,</span>
    <span class="s1">&#39;top_k_trigrams&#39;</span><span class="p">:</span> <span class="s1">&#39;get_top_k_trigrams&#39;</span><span class="p">,</span>
    <span class="s1">&#39;top_k_fourgrams&#39;</span><span class="p">:</span> <span class="s1">&#39;get_top_k_fourgrams&#39;</span>
<span class="p">}</span>

<span class="n">features_params_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;classes_in_radius_bln&#39;</span><span class="p">:</span> <span class="s1">&#39;classes_in_radius_thr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_radius_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;classes_in_radius_thr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_and_radius_bln&#39;</span><span class="p">:</span> <span class="s1">&#39;classes_in_street_and_radius_thr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_and_radius_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;classes_in_street_and_radius_thr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_neighbors_bln&#39;</span><span class="p">:</span> <span class="s1">&#39;classes_in_neighbors_thr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_neighbors_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;classes_in_neighbors_thr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_radius_bln&#39;</span><span class="p">:</span> <span class="s1">&#39;classes_in_street_radius_thr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;classes_in_street_radius_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;classes_in_street_radius_thr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;top_k_terms&#39;</span><span class="p">:</span> <span class="s1">&#39;top_k_terms_pct&#39;</span><span class="p">,</span>
    <span class="s1">&#39;top_k_trigrams&#39;</span><span class="p">:</span> <span class="s1">&#39;top_k_trigrams_pct&#39;</span><span class="p">,</span>
    <span class="s1">&#39;top_k_fourgrams&#39;</span><span class="p">:</span> <span class="s1">&#39;top_k_fourgrams_pct&#39;</span>
<span class="p">}</span>

<span class="n">features_getter_args_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;classes_in_radius_bln&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;poi_index_path&#39;</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">,</span> <span class="s1">&#39;label_map&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">),</span>
    <span class="s1">&#39;classes_in_radius_cnt&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;poi_index_path&#39;</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">,</span> <span class="s1">&#39;label_map&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">),</span>
    <span class="s1">&#39;classes_in_street_and_radius_bln&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;street_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;pois_by_street&#39;</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">,</span> <span class="s1">&#39;label_map&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry_map&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">),</span>
    <span class="s1">&#39;classes_in_street_and_radius_cnt&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;street_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;pois_by_street&#39;</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">,</span> <span class="s1">&#39;label_map&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry_map&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">),</span>
    <span class="s1">&#39;classes_in_neighbors_bln&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;poi_index_path&#39;</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">,</span> <span class="s1">&#39;label_map&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">),</span>
    <span class="s1">&#39;classes_in_neighbors_cnt&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;poi_index_path&#39;</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">,</span> <span class="s1">&#39;label_map&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">),</span>
    <span class="s1">&#39;classes_in_street_radius_bln&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;street_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">,</span> <span class="s1">&#39;label_map&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry_map&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">),</span>
    <span class="s1">&#39;classes_in_street_radius_cnt&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;street_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">,</span> <span class="s1">&#39;label_map&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry_map&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">),</span>
    <span class="s1">&#39;similarity_per_class&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;textual_index_path&#39;</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">),</span>
    <span class="s1">&#39;top_k_terms&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;names&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">),</span>
    <span class="s1">&#39;top_k_trigrams&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;names&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">),</span>
    <span class="s1">&#39;top_k_fourgrams&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;names&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">)</span>
<span class="p">}</span>


<div class="viewcode-block" id="load_poi_gdf"><a class="viewcode-back" href="../features_utilities.html#features_utilities.load_poi_gdf">[docs]</a><span class="k">def</span> <span class="nf">load_poi_gdf</span><span class="p">(</span><span class="n">poi_fpath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads pois in *poi_fpath* into a geopandas.GeoDataFrame and project their \</span>
<span class="sd">    geometries.</span>

<span class="sd">    Args:</span>
<span class="sd">        poi_fpath (str): Path to file containing the pois</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">poi_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">poi_fpath</span><span class="p">)</span>
    <span class="n">poi_df</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poi_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">lon_col</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">lat_col</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">poi_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">poi_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
    <span class="n">poi_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s1">&#39;epsg:</span><span class="si">{config.poi_crs}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="n">poi_gdf</span> <span class="o">=</span> <span class="n">poi_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">({</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:3857&#39;</span><span class="p">})</span>
    <span class="n">poi_gdf</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poi_gdf</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">poi_gdf</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poi_gdf</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">poi_gdf</span></div>


<div class="viewcode-block" id="encode_labels"><a class="viewcode-back" href="../features_utilities.html#features_utilities.encode_labels">[docs]</a><span class="k">def</span> <span class="nf">encode_labels</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">encoder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encodes target column to with integer values.</span>

<span class="sd">    Args:</span>
<span class="sd">        poi_gdf (geopandas.GeoDataFrame): The GeoDataFrame containing the \</span>
<span class="sd">            column to be encoded</span>
<span class="sd">        encoder (sklearn.preprocessing.LabelEncoder, optional): The label \</span>
<span class="sd">            encoder to be utilized</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame: The GeoDataFrame with the encoded column</span>
<span class="sd">        sklearn.preprocessing.LabelEncoder: The label encoder utilized</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">encoder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
        <span class="n">poi_gdf</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">label_col</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">poi_gdf</span> <span class="o">=</span> <span class="n">poi_gdf</span><span class="p">[</span><span class="n">poi_gdf</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">poi_gdf</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">label_col</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">poi_gdf</span><span class="p">,</span> <span class="n">encoder</span></div>


<div class="viewcode-block" id="load_street_gdf"><a class="viewcode-back" href="../features_utilities.html#features_utilities.load_street_gdf">[docs]</a><span class="k">def</span> <span class="nf">load_street_gdf</span><span class="p">(</span><span class="n">street_fpath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads streets in *street_fpath* into a geopandas.GeoDataFrame and project \</span>
<span class="sd">    their geometries.</span>

<span class="sd">    Args:</span>
<span class="sd">        street_fpath (str): Path to file containing the streets</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.GeoDataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">street_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">street_fpath</span><span class="p">)</span>
    <span class="n">street_df</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">street_df</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">loads</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">street_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">street_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
    <span class="n">street_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s1">&#39;epsg:</span><span class="si">{config.osm_crs}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="n">street_gdf</span> <span class="o">=</span> <span class="n">street_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">({</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="s1">&#39;epsg:3857&#39;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">street_gdf</span></div>


<span class="c1"># def load_poly_gdf(poly_fpath):</span>
<span class="c1">#     poly_df = pd.read_csv(poly_fpath)</span>
<span class="c1">#     poly_df[&#39;geometry&#39;] = poly_df[&#39;geometry&#39;].apply(lambda x: loads(x))</span>
<span class="c1">#     poly_gdf = gpd.GeoDataFrame(poly_df, geometry=&#39;geometry&#39;)</span>
<span class="c1">#     poly_gdf.crs = {&#39;init&#39;: f&#39;epsg:{config.osm_crs}&#39;}</span>
<span class="c1">#     poly_gdf = poly_gdf.to_crs({&#39;init&#39;: &#39;epsg:3857&#39;})</span>
<span class="c1">#     return poly_gdf</span>


<div class="viewcode-block" id="get_bbox_coords"><a class="viewcode-back" href="../features_utilities.html#features_utilities.get_bbox_coords">[docs]</a><span class="k">def</span> <span class="nf">get_bbox_coords</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a bounding box containing all *poi_gdf*&#39;s pois.</span>

<span class="sd">    Args:</span>
<span class="sd">        poi_gdf (geopandas.GeoDataFrame): Contains the pois</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: The bounding box coords as (south, west, north, east)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">poi_gdf</span> <span class="o">=</span> <span class="n">poi_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">({</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s1">&#39;epsg:</span><span class="si">{config.osm_crs}</span><span class="s1">&#39;</span><span class="p">})</span>
    <span class="n">min_lon</span><span class="p">,</span> <span class="n">min_lat</span><span class="p">,</span> <span class="n">max_lon</span><span class="p">,</span> <span class="n">max_lat</span> <span class="o">=</span> <span class="n">poi_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">total_bounds</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">min_lat</span><span class="p">,</span> <span class="n">min_lon</span><span class="p">,</span> <span class="n">max_lat</span><span class="p">,</span> <span class="n">max_lon</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_required_external_files"><a class="viewcode-back" href="../features_utilities.html#features_utilities.get_required_external_files">[docs]</a><span class="k">def</span> <span class="nf">get_required_external_files</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">feature_sets_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if external files are required and if so, downloads them using the \</span>
<span class="sd">    Overpass API.</span>

<span class="sd">    Args:</span>
<span class="sd">        poi_gdf (geopandas.GeoDataFrame): Contains pois in order to define \</span>
<span class="sd">            the area to query with Overpass API</span>
<span class="sd">        feature_sets_path (str): Path to store the downloaded elements</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s1">&#39;classes_in_street_and_radius_bln&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">included_adjacency_features</span> <span class="ow">or</span>
        <span class="s1">&#39;classes_in_street_and_radius_cnt&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">included_adjacency_features</span> <span class="ow">or</span>
        <span class="s1">&#39;classes_in_street_radius_bln&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">included_adjacency_features</span> <span class="ow">or</span>
        <span class="s1">&#39;classes_in_street_radius_cnt&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">included_adjacency_features</span>
       <span class="p">):</span>
        <span class="n">osm_ut</span><span class="o">.</span><span class="n">download_osm_streets</span><span class="p">(</span><span class="n">get_bbox_coords</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">),</span> <span class="n">feature_sets_path</span><span class="p">)</span>
    <span class="c1"># if config.included_geometric_features:</span>
    <span class="c1">#     osm_ut.download_osm_polygons(get_bbox_coords(poi_gdf), feature_sets_path)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="ngrams"><a class="viewcode-back" href="../features_utilities.html#features_utilities.ngrams">[docs]</a><span class="k">def</span> <span class="nf">ngrams</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of all *n*-grams of *word*.</span>

<span class="sd">    Args:</span>
<span class="sd">        n (int): The length of character ngrams to be extracted</span>
<span class="sd">        word (str): The word of which the ngrams are to be extracted</span>

<span class="sd">    Yields:</span>
<span class="sd">        str: ngram</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_top_k"><a class="viewcode-back" href="../features_utilities.html#features_utilities.get_top_k">[docs]</a><span class="k">def</span> <span class="nf">get_top_k</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;term&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the top *k* % terms or ngrams of *names*, based on *mode*.</span>

<span class="sd">    Args:</span>
<span class="sd">        names (list): Contains the names to be considered</span>
<span class="sd">        k (float): Percentage of top terms or ngrams to be considered</span>
<span class="sd">        mode (str, optional): May be &#39;term&#39;, &#39;trigram&#39; or &#39;fourgram&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Contains the top k terms or ngrams</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;trigram&#39;</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">ngram</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">for</span> <span class="n">ngram</span> <span class="ow">in</span> <span class="n">ngrams</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">word</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fourgram&#39;</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">ngram</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">for</span> <span class="n">ngram</span> <span class="ow">in</span> <span class="n">ngrams</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">word</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cnt</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span><span class="p">))]</span></div>


<div class="viewcode-block" id="normalize_features"><a class="viewcode-back" href="../features_utilities.html#features_utilities.normalize_features">[docs]</a><span class="k">def</span> <span class="nf">normalize_features</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize features to [0, 1].</span>

<span class="sd">    Args:</span>
<span class="sd">        X (numpy.ndarray): Features array to be normalized</span>
<span class="sd">        train_idxs (numpy.ndarray): Contains the train indexes</span>
<span class="sd">        scaler (sklearn.preprocessing.MinMaxScaler, optional): Scaler to be \</span>
<span class="sd">            utilized</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The normalized features array</span>
<span class="sd">        sklearn.preprocessing.MinMaxScaler: The scaler utilized</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">X_</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">train_idxs</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_idxs</span><span class="p">):</span>
            <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">test_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">train_idxs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">test_idxs</span><span class="p">:</span>
            <span class="n">X_</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">test_idxs</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_idxs</span><span class="p">):</span>
                <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">scaler</span></div>


<div class="viewcode-block" id="get_pois_by_street"><a class="viewcode-back" href="../features_utilities.html#features_utilities.get_pois_by_street">[docs]</a><span class="k">def</span> <span class="nf">get_pois_by_street</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">street_gdf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Matches each poi in *poi_gdf* to its nearest street.</span>

<span class="sd">    Args:</span>
<span class="sd">        poi_gdf (geopandas.GeoDataFrame): Contains pois to be matched to \</span>
<span class="sd">            a street</span>
<span class="sd">        street_gdf (geopandas.GeoDataFrame): Contains streets to search among \</span>
<span class="sd">            them for the nearest to each poi</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Has streets ids as keys and a list containing the pois which \</span>
<span class="sd">            belong to each street as values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">street_index</span> <span class="o">=</span> <span class="n">street_gdf</span><span class="o">.</span><span class="n">sindex</span>
    <span class="n">pois_by_street</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">street_gdf</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">poi</span> <span class="ow">in</span> <span class="n">poi_gdf</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">poi_coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">poi</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">poi</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">street_index</span><span class="o">.</span><span class="n">nearest</span><span class="p">(</span><span class="n">poi_coords</span><span class="p">))</span>
        <span class="n">nearest</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span>
            <span class="n">Point</span><span class="p">(</span><span class="n">poi_coords</span><span class="p">)</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">street_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span>
        <span class="p">])]</span>
        <span class="n">pois_by_street</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poi</span><span class="o">.</span><span class="n">Index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pois_by_street</span></div>


<div class="viewcode-block" id="create_args_dict"><a class="viewcode-back" href="../features_utilities.html#features_utilities.create_args_dict">[docs]</a><span class="k">def</span> <span class="nf">create_args_dict</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">required_args</span><span class="p">,</span> <span class="n">read_path</span><span class="p">,</span> <span class="n">write_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes and prepares structures required during features extraction.</span>

<span class="sd">    Args:</span>
<span class="sd">        poi_gdf (geopandas.GeoDataFrame): Contains the pois for which \</span>
<span class="sd">            features will be created</span>
<span class="sd">        train_idxs (numpy.ndarray): Contains the train indexes</span>
<span class="sd">        required_args (set): Contains the names of the required args</span>
<span class="sd">        read_path (str): Path to read from</span>
<span class="sd">        write_path (str): Path to write to</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Containing arguments names as keys and their corresponding \</span>
<span class="sd">            structures as values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">:</span> <span class="n">poi_gdf</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">:</span> <span class="n">poi_gdf</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()}</span>
    <span class="k">if</span> <span class="s1">&#39;label_map&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;label_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poi_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idxs</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;geometry_map&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;geometry_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poi_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idxs</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;poi_index_path&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;poi_index_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_path</span> <span class="o">+</span> <span class="s1">&#39;/poi_index.pkl&#39;</span>
        <span class="n">af</span><span class="o">.</span><span class="n">create_poi_index</span><span class="p">(</span><span class="n">poi_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idxs</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;poi_index_path&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;street_gdf&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">street_csv_path</span> <span class="o">=</span> <span class="n">read_path</span> <span class="o">+</span> <span class="s1">&#39;/osm_streets.csv&#39;</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;street_gdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_street_gdf</span><span class="p">(</span><span class="n">street_csv_path</span><span class="p">)</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;pois_by_street&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_pois_by_street</span><span class="p">(</span><span class="n">poi_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idxs</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;street_gdf&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;textual_index_path&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;textual_index_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_path</span> <span class="o">+</span> <span class="s1">&#39;/textual_index&#39;</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">create_textual_index</span><span class="p">(</span><span class="n">poi_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idxs</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;textual_index_path&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;names&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">poi_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idxs</span><span class="p">][</span><span class="n">config</span><span class="o">.</span><span class="n">name_col</span><span class="p">]))</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">args</span></div>


<div class="viewcode-block" id="create_single_feature"><a class="viewcode-back" href="../features_utilities.html#features_utilities.create_single_feature">[docs]</a><span class="k">def</span> <span class="nf">create_single_feature</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">scaler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the features array given a feature&#39;s name *f*.</span>

<span class="sd">    Args:</span>
<span class="sd">        f (str): Feature name to be created</span>
<span class="sd">        args (dict): Containing the required arguments for feature *f*</span>
<span class="sd">        train_idxs (numpy.ndarray): Contains the train indexes</span>
<span class="sd">        norm (boolean): Indicating whether the feature should be normalized \</span>
<span class="sd">            or not</span>
<span class="sd">        scaler (sklearn.preprocessing.MinMaxScaler): The scaler to be utilized</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The features array of feature *f*</span>
<span class="sd">        sklearn.preprocessing.MinMaxScaler: The scaler utilized</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">feature_module_map</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">features_getter_map</span><span class="p">[</span><span class="n">f</span><span class="p">])(</span>
        <span class="o">*</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">features_getter_args_map</span><span class="p">[</span><span class="n">f</span><span class="p">]])</span>
    <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">normalize_features</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">norm</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">normalize_features</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="create_single_features"><a class="viewcode-back" href="../features_utilities.html#features_utilities.create_single_features">[docs]</a><span class="k">def</span> <span class="nf">create_single_features</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">fold_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates all the included features arrays and saves them in *fold_path*.</span>

<span class="sd">    Args:</span>
<span class="sd">        poi_gdf (geopandas.GeoDataFrame): Contains the pois for which the \</span>
<span class="sd">            features will be created</span>
<span class="sd">        train_idxs (numpy.ndarray): Contains the train indexes</span>
<span class="sd">        fold_path (str): Path to save features arrays</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fold_path</span> <span class="o">+</span> <span class="s1">&#39;/tmp&#39;</span><span class="p">)</span>

    <span class="n">included_features</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">included_adjacency_features</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">included_textual_features</span>
    <span class="n">required_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">arg</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">included_features</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">features_getter_args_map</span><span class="p">[</span><span class="n">f</span><span class="p">]])</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">create_args_dict</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">required_args</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fold_path</span><span class="p">),</span> <span class="n">fold_path</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">included_features</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">normalized_features</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features_params_map</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_single_feature</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fold_path</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;/tmp/</span><span class="si">{f}</span><span class="s1">.npy&#39;</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">features_params_map</span><span class="p">[</span><span class="n">f</span><span class="p">]):</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_single_feature</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fold_path</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;/tmp/</span><span class="si">{f}</span><span class="s1">_</span><span class="si">{p}</span><span class="s1">.npy&#39;</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="create_concatenated_features"><a class="viewcode-back" href="../features_utilities.html#features_utilities.create_concatenated_features">[docs]</a><span class="k">def</span> <span class="nf">create_concatenated_features</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">train_idxs</span><span class="p">,</span> <span class="n">test_idxs</span><span class="p">,</span> <span class="n">fold_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads a list of included features arrays in order to concatenate them \</span>
<span class="sd">    into the final X_train and X_test arrays. Then saves these arrays as well \</span>
<span class="sd">    as the corresponding y_train and y_test arrays. Finally, writes the \</span>
<span class="sd">    included features configuration into a file.</span>

<span class="sd">    Args:</span>
<span class="sd">        poi_gdf (geopandas.GeoDataFrame): Contains the pois for which the \</span>
<span class="sd">            features will be created</span>
<span class="sd">        train_idxs (numpy.ndarray): Contains the train indexes</span>
<span class="sd">        test_idxs (numpy.ndarray): Contains the test indexes</span>
<span class="sd">        fold_path (str): Path to save features arrays</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">included_features</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">included_adjacency_features</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">included_textual_features</span>
    <span class="n">params_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">features_params_map</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">included_features</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features_params_map</span><span class="p">]))</span>
    <span class="n">params_vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params_names</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">poi_gdf</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">params_vals</span><span class="p">)):</span>
        <span class="n">features_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">params_names</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">included_features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features_params_map</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">features_params</span><span class="p">[</span><span class="n">features_params_map</span><span class="p">[</span><span class="n">f</span><span class="p">]]</span>
                <span class="n">Xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fold_path</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;/tmp/</span><span class="si">{f}</span><span class="s1">_</span><span class="si">{p}</span><span class="s1">.npy&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fold_path</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;/tmp/</span><span class="si">{f}</span><span class="s1">.npy&#39;</span><span class="p">))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span>
        <span class="c1"># X = SelectPercentile(chi2, percentile=75).fit_transform(X, y)</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train_idxs</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">test_idxs</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fold_path</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;/X_train_</span><span class="si">{idx}</span><span class="s1">.npy&#39;</span><span class="p">,</span> <span class="n">X_train</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fold_path</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;/X_test_</span><span class="si">{idx}</span><span class="s1">.npy&#39;</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>

    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">train_idxs</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">test_idxs</span><span class="p">]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fold_path</span> <span class="o">+</span> <span class="s1">&#39;/y_train.npy&#39;</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fold_path</span> <span class="o">+</span> <span class="s1">&#39;/y_test.npy&#39;</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fold_path</span><span class="p">)</span>
    <span class="n">wrtrs</span><span class="o">.</span><span class="n">write_feature_params_info</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/params_per_feature_set.csv&#39;</span><span class="p">,</span> <span class="n">params_names</span><span class="p">,</span> <span class="n">params_vals</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="create_finetuned_features"><a class="viewcode-back" href="../features_utilities.html#features_utilities.create_finetuned_features">[docs]</a><span class="k">def</span> <span class="nf">create_finetuned_features</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">features_info</span><span class="p">,</span> <span class="n">best_feature_params</span><span class="p">,</span> <span class="n">features_path</span><span class="p">,</span> <span class="n">results_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and saves the X_train features array for the model_training step.</span>

<span class="sd">    Args:</span>
<span class="sd">        poi_gdf (geopandas.GeoDataFrame): Contains the pois for which the \</span>
<span class="sd">            features will be created</span>
<span class="sd">        features_info (list): Containing the features (and whether they \</span>
<span class="sd">            should be normalized or not) to be extracted</span>
<span class="sd">        best_feature_params (dict): Containing the best found features \</span>
<span class="sd">            parameters values</span>
<span class="sd">        features_path (str): Path in order to read required external files \</span>
<span class="sd">            (like osm streets file)</span>
<span class="sd">        results_path (str): Path to write to</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The features array for model_training step</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">included_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features_info</span><span class="p">]</span>
    <span class="n">required_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">arg</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">included_features</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">features_getter_args_map</span><span class="p">[</span><span class="n">f</span><span class="p">]])</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">create_args_dict</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">)),</span> <span class="n">required_args</span><span class="p">,</span> <span class="n">features_path</span><span class="p">,</span> <span class="n">results_path</span> <span class="o">+</span> <span class="s1">&#39;/pickled_objects&#39;</span><span class="p">)</span>

    <span class="n">Xs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features_info</span><span class="p">:</span>
        <span class="n">feat</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">features_params_map</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_feature_params</span><span class="p">[</span><span class="n">features_params_map</span><span class="p">[</span><span class="n">feat</span><span class="p">]]</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">scaler</span> <span class="o">=</span> <span class="n">create_single_feature</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">)),</span> <span class="n">norm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">scaler</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_path</span> <span class="o">+</span> <span class="s1">&#39;/pickled_objects&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;/</span><span class="si">{feat}</span><span class="s1">_scaler.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
        <span class="n">Xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">results_path</span> <span class="o">+</span> <span class="s1">&#39;/X_train.npy&#39;</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span></div>


<div class="viewcode-block" id="create_test_args_dict"><a class="viewcode-back" href="../features_utilities.html#features_utilities.create_test_args_dict">[docs]</a><span class="k">def</span> <span class="nf">create_test_args_dict</span><span class="p">(</span><span class="n">test_poi_gdf</span><span class="p">,</span> <span class="n">required_args</span><span class="p">,</span> <span class="n">read_path1</span><span class="p">,</span> <span class="n">read_path2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiate and prepare structures required during features extraction in \</span>
<span class="sd">    model_deployment step.</span>

<span class="sd">    Args:</span>
<span class="sd">        test_poi_gdf (geopandas.GeoDataFrame): Contains the pois for which \</span>
<span class="sd">            features will be created</span>
<span class="sd">        required_args (set): Contains the names of the required args</span>
<span class="sd">        read_path1 (str): Path to features_extraction step results</span>
<span class="sd">        read_path2 (str): Path to model_training step results</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Containing arguments names as keys and their corresponding \</span>
<span class="sd">            structures as values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">train_poi_gdf</span> <span class="o">=</span> <span class="n">load_poi_gdf</span><span class="p">(</span><span class="n">read_path1</span> <span class="o">+</span> <span class="s1">&#39;/train_poi_gdf.csv&#39;</span><span class="p">)</span>
    <span class="n">encoder</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">read_path1</span> <span class="o">+</span> <span class="s1">&#39;/encoder.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="n">train_poi_gdf</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">encode_labels</span><span class="p">(</span><span class="n">train_poi_gdf</span><span class="p">,</span> <span class="n">encoder</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;poi_gdf&#39;</span><span class="p">:</span> <span class="n">test_poi_gdf</span><span class="p">,</span> <span class="s1">&#39;nlabels&#39;</span><span class="p">:</span> <span class="n">train_poi_gdf</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()}</span>
    <span class="k">if</span> <span class="s1">&#39;label_map&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;label_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_poi_gdf</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;geometry_map&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;geometry_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_poi_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;poi_index_path&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;poi_index_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_path2</span> <span class="o">+</span> <span class="s1">&#39;/poi_index.pkl&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;street_gdf&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">street_csv_path</span> <span class="o">=</span> <span class="n">read_path1</span> <span class="o">+</span> <span class="s1">&#39;/osm_streets.csv&#39;</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;street_gdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_street_gdf</span><span class="p">(</span><span class="n">street_csv_path</span><span class="p">)</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;pois_by_street&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_pois_by_street</span><span class="p">(</span><span class="n">train_poi_gdf</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;street_gdf&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;textual_index_path&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;textual_index_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_path2</span> <span class="o">+</span> <span class="s1">&#39;/textual_index&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;names&#39;</span> <span class="ow">in</span> <span class="n">required_args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">train_poi_gdf</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">name_col</span><span class="p">]))</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">args</span></div>


<div class="viewcode-block" id="create_test_features"><a class="viewcode-back" href="../features_utilities.html#features_utilities.create_test_features">[docs]</a><span class="k">def</span> <span class="nf">create_test_features</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">features_path</span><span class="p">,</span> <span class="n">model_training_path</span><span class="p">,</span> <span class="n">results_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and saves the X_test features array for the model_deployment step.</span>

<span class="sd">    Args:</span>
<span class="sd">        poi_gdf (geopandas.GeoDataFrame): Contains the pois for which the \</span>
<span class="sd">            features will be created</span>
<span class="sd">        features (list): Containing the features (as well as their best found \</span>
<span class="sd">            configuration) to be extracted</span>
<span class="sd">        features_path (str): Path to features_extraction step results</span>
<span class="sd">        model_training_path (str): Path to model_training step results</span>
<span class="sd">        results_path (str): Path to write to</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The features array for model_deployment step</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">included_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>
    <span class="n">required_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">arg</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">included_features</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">features_getter_args_map</span><span class="p">[</span><span class="n">f</span><span class="p">]])</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">create_test_args_dict</span><span class="p">(</span><span class="n">poi_gdf</span><span class="p">,</span> <span class="n">required_args</span><span class="p">,</span> <span class="n">features_path</span><span class="p">,</span> <span class="n">model_training_path</span> <span class="o">+</span> <span class="s1">&#39;/pickled_objects&#39;</span><span class="p">)</span>

    <span class="n">Xs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">feat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">param_value</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">features_params_map</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">feature_module_map</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">==</span> <span class="n">af</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">model_training_path</span> <span class="o">+</span> <span class="s1">&#39;/pickled_objects&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;/</span><span class="si">{feat}</span><span class="s1">_scaler.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_single_feature</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_single_feature</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">Xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">results_path</span> <span class="o">+</span> <span class="s1">&#39;/X_test.npy&#39;</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, kgalexis, giann

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>